name: Create PR from Azure DevOps User Story

on:
  repository_dispatch:
    types: [azure-devops-user-story-created]
  # Also support direct webhook calls from Azure DevOps
  workflow_dispatch:
    inputs:
      workItemId:
        description: "Work Item ID"
        required: true
        type: string
      title:
        description: "User Story Title"
        required: true
        type: string
      description:
        description: "Description"
        required: false
        type: string
      acceptanceCriteria:
        description: "Acceptance Criteria"
        required: false
        type: string
      assignedTo:
        description: "Assigned To"
        required: false
        type: string
      url:
        description: "Azure DevOps URL"
        required: false
        type: string

jobs:
  create-pull-request:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract user story details
        id: extract
        run: |
          # Support both repository_dispatch and workflow_dispatch
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            WORK_ITEM_ID="${{ github.event.client_payload.workItemId }}"
            TITLE="${{ github.event.client_payload.title }}"
            DESCRIPTION="${{ github.event.client_payload.description }}"
            ACCEPTANCE_CRITERIA="${{ github.event.client_payload.acceptanceCriteria }}"
            ASSIGNED_TO="${{ github.event.client_payload.assignedTo }}"
            URL="${{ github.event.client_payload.url }}"
          else
            WORK_ITEM_ID="${{ inputs.workItemId }}"
            TITLE="${{ inputs.title }}"
            DESCRIPTION="${{ inputs.description }}"
            ACCEPTANCE_CRITERIA="${{ inputs.acceptanceCriteria }}"
            ASSIGNED_TO="${{ inputs.assignedTo }}"
            URL="${{ inputs.url }}"
          fi

          echo "User Story ID: $WORK_ITEM_ID"
          echo "Title: $TITLE"
          echo "Description: $DESCRIPTION"

          # Create branch name from user story ID
          BRANCH_NAME="feature/US-$WORK_ITEM_ID"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "work_item_id=$WORK_ITEM_ID" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "acceptance_criteria=$ACCEPTANCE_CRITERIA" >> $GITHUB_OUTPUT
          echo "assigned_to=$ASSIGNED_TO" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT

          # Sanitize title for PR
          echo "pr_title=US-$WORK_ITEM_ID: $TITLE" >> $GITHUB_OUTPUT

      - name: Configure Git
        run: |
          git config user.name "Azure DevOps Bot"
          git config user.email "azuredevops-bot@users.noreply.github.com"

      - name: Create feature branch
        run: |
          git checkout -b ${{ steps.extract.outputs.branch_name }}

          # Create a placeholder file for the feature
          mkdir -p .azure-devops
          cat > .azure-devops/US-${{ steps.extract.outputs.work_item_id }}.md << 'EOF'
          # User Story: ${{ steps.extract.outputs.title }}

          **Azure DevOps Work Item ID:** ${{ steps.extract.outputs.work_item_id }}

          ## Description
          ${{ steps.extract.outputs.description }}

          ## Acceptance Criteria
          ${{ steps.extract.outputs.acceptance_criteria }}

          ## Tasks
          - [ ] Implementation
          - [ ] Unit Tests
          - [ ] Documentation
          - [ ] Code Review

          ---
          *This file was automatically generated from Azure DevOps*
          EOF

          git add .azure-devops/US-${{ steps.extract.outputs.work_item_id }}.md
          git commit -m "feat: Initialize user story US-${{ steps.extract.outputs.work_item_id }}"
          git push origin ${{ steps.extract.outputs.branch_name }}

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create PR body
          PR_BODY=$(cat << 'EOF'
          ## ðŸ“‹ User Story

          **Azure DevOps Work Item:** [${{ steps.extract.outputs.work_item_id }}](${{ steps.extract.outputs.url }})

          ### Description
          ${{ steps.extract.outputs.description }}

          ### Acceptance Criteria
          ${{ steps.extract.outputs.acceptance_criteria }}

          ---

          ### âœ… Engineer Checklist
          - [ ] Code implements all acceptance criteria
          - [ ] Unit tests added/updated
          - [ ] Integration tests pass
          - [ ] Code follows project coding standards
          - [ ] Documentation updated
          - [ ] No merge conflicts with develop

          ### ðŸ”— Related Links
          - [Azure DevOps User Story](${{ steps.extract.outputs.url }})

          ---
          *This PR was automatically created from Azure DevOps User Story #${{ steps.extract.outputs.work_item_id }}*
          EOF
          )

          # Create the pull request
          gh pr create \
            --title "${{ steps.extract.outputs.pr_title }}" \
            --body "$PR_BODY" \
            --base main \
            --head ${{ steps.extract.outputs.branch_name }} \
            --label "user-story,azure-devops" \
            --assignee "${{ steps.extract.outputs.assigned_to }}" || true

      - name: Comment on Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the PR number
          PR_NUMBER=$(gh pr view ${{ steps.extract.outputs.branch_name }} --json number -q .number)

          # Add a comment with instructions
          gh pr comment $PR_NUMBER --body "ðŸ‘‹ **Engineer**, this PR was created automatically from Azure DevOps.

          **Next Steps:**
          1. Review the user story requirements in the Azure DevOps link above
          2. Implement the feature in this branch
          3. Ensure all acceptance criteria are met
          4. Request review when ready

          Once approved and merged, please update the Azure DevOps work item status."
          
      - name: Trigger AI Code Generation
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the PR number
          PR_NUMBER=$(gh pr view ${{ steps.extract.outputs.branch_name }} --json number -q .number)
          
          # Wait a moment for PR to be fully created
          sleep 5
          
          # Use repository_dispatch to trigger the AI workflow
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d "{\"event_type\":\"generate-code\",\"client_payload\":{\"pr_number\":$PR_NUMBER,\"branch\":\"${{ steps.extract.outputs.branch_name }}\"}}"
