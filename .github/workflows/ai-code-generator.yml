name: AI Agent - Auto-Generate Code Implementation

on:
  repository_dispatch:
    types: [generate-code]
  pull_request:
    types: [opened]
    branches:
      - main
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to generate code for"
        required: true
        type: number
  issue_comment:
    types: [created]

jobs:
  generate-code:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Get PR Number
        id: pr_number
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "number=${{ github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get PR Branch
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr_number.outputs.number }}
            });
            core.setOutput('branch', pr.head.ref);
            return pr;

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_info.outputs.branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Read User Story
        id: user_story
        run: |
          # Find the user story file
          US_FILE=$(find .azure-devops -name "US-*.md" 2>/dev/null | head -n 1)

          if [ -z "$US_FILE" ]; then
            echo "No user story found"
            exit 1
          fi

          # Extract user story details
          CONTENT=$(cat "$US_FILE")
          US_ID=$(basename "$US_FILE" .md | sed 's/US-//')

          # Parse the content
          TITLE=$(echo "$CONTENT" | grep "^# User Story:" | sed 's/# User Story: //')
          DESCRIPTION=$(echo "$CONTENT" | sed -n '/## Description/,/## Acceptance Criteria/p' | grep -v "^##" | sed '/^$/d')
          CRITERIA=$(echo "$CONTENT" | sed -n '/## Acceptance Criteria/,/## Tasks/p' | grep -v "^##" | sed '/^$/d')

          echo "us_id=$US_ID" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "description<<EOF" >> $GITHUB_OUTPUT
          echo "$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "criteria<<EOF" >> $GITHUB_OUTPUT
          echo "$CRITERIA" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze Codebase
        id: analyze
        run: |
          # Detect project structure
          if [ -d "src/components" ]; then
            echo "has_react=true" >> $GITHUB_OUTPUT
            echo "react_components=$(find src/components -name '*.jsx' -o -name '*.tsx' 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
          fi

          # Get data models
          if [ -f "public/Data/embassies.json" ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate React Component (if applicable)
        if: steps.analyze.outputs.has_react == 'true'
        run: |
          # Extract feature name from user story
          FEATURE_NAME=$(echo "${{ steps.user_story.outputs.title }}" | sed 's/.*want to //' | sed 's/ .*//' | sed 's/[^a-zA-Z]//g')
          COMPONENT_NAME="${FEATURE_NAME^}"  # Capitalize first letter

          # Create component directory
          mkdir -p "src/components/$COMPONENT_NAME"

          # Generate React component based on user story
          cat > "src/components/$COMPONENT_NAME/${COMPONENT_NAME}.jsx" << EOF
          import React, { useState, useEffect } from 'react';
          import './${COMPONENT_NAME}.css';

          /**
           * $COMPONENT_NAME Component
           * 
           * User Story: ${{ steps.user_story.outputs.title }}
           * 
           * Description: ${{ steps.user_story.outputs.description }}
           * 
           * Acceptance Criteria:
           * ${{ steps.user_story.outputs.criteria }}
           */
          const $COMPONENT_NAME = () => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
              // TODO: Implement data fetching logic
              // Based on acceptance criteria from user story
              fetchData();
            }, []);

            const fetchData = async () => {
              try {
                setLoading(true);
                // TODO: Replace with actual API endpoint
                const response = await fetch('/api/data');
                const result = await response.json();
                setData(result);
              } catch (err) {
                setError(err.message);
              } finally {
                setLoading(false);
              }
            };

            if (loading) {
              return <div className="${COMPONENT_NAME,,}-loading">Loading...</div>;
            }

            if (error) {
              return <div className="${COMPONENT_NAME,,}-error">Error: {error}</div>;
            }

            return (
              <div className="${COMPONENT_NAME,,}">
                <h2>$COMPONENT_NAME</h2>
                {/* TODO: Implement UI based on acceptance criteria */}
                <div className="${COMPONENT_NAME,,}-content">
                  {/* Add your implementation here */}
                  <p>Feature implementation pending. See user story for details.</p>
                </div>
              </div>
            );
          };

          export default $COMPONENT_NAME;
          EOF

          # Generate CSS file
          cat > "src/components/$COMPONENT_NAME/${COMPONENT_NAME}.css" << EOF
          /* $COMPONENT_NAME Styles */

          .${COMPONENT_NAME,,} {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
          }

          .${COMPONENT_NAME,,}-loading,
          .${COMPONENT_NAME,,}-error {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
          }

          .${COMPONENT_NAME,,}-error {
            color: #d32f2f;
          }

          .${COMPONENT_NAME,,}-content {
            margin-top: 20px;
          }

          /* TODO: Add specific styles based on design requirements */
          EOF

          # Generate index file
          cat > "src/components/$COMPONENT_NAME/index.js" << EOF
          export { default } from './${COMPONENT_NAME}';
          EOF

          echo "Generated React component: $COMPONENT_NAME"

      - name: Update App.jsx (integrate new component)
        if: steps.analyze.outputs.has_react == 'true'
        run: |
          FEATURE_NAME=$(echo "${{ steps.user_story.outputs.title }}" | sed 's/.*want to //' | sed 's/ .*//' | sed 's/[^a-zA-Z]//g')
          COMPONENT_NAME="${FEATURE_NAME^}"

          # Add import and TODO comment to App.jsx if it exists
          if [ -f "src/App.jsx" ]; then
            # Create a backup
            cp src/App.jsx src/App.jsx.bak
            
            # Add import at the top (after other imports)
            sed -i "/^import/a import $COMPONENT_NAME from './components/$COMPONENT_NAME';" src/App.jsx
            
            # Add TODO comment
            echo "" >> src/App.jsx
            echo "// TODO: Integrate $COMPONENT_NAME component based on user story US-${{ steps.user_story.outputs.us_id }}" >> src/App.jsx
            echo "// Example: <$COMPONENT_NAME />" >> src/App.jsx
          fi

      - name: Commit Generated Code
        run: |
          git config user.name "AI Code Generator Bot"
          git config user.email "ai-bot[bot]@users.noreply.github.com"

          git add .

          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "feat(US-${{ steps.user_story.outputs.us_id }}): AI-generated code scaffolding

            - Generated React component with basic structure
            - All code includes TODOs based on acceptance criteria
            
            User Story: ${{ steps.user_story.outputs.title }}
            
            Note: This is AI-generated starter code. Please review and implement
            the business logic according to the acceptance criteria."
            
            git push
          else
            echo "No changes to commit"
          fi

      - name: Post Success Comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ü§ñ AI Code Generation Complete!

            I've analyzed the user story and generated starter code for you. Here's what I created:

            ### ‚úÖ Generated Files:
            - React component with basic structure
            - CSS styles
            - Component index file

            ### üìù Next Steps:
            1. Pull the latest changes from this branch
            2. Review the generated code in your IDE
            3. Replace TODO comments with actual business logic
            4. Test against acceptance criteria

            ### üí° Tips:
            - Use GitHub Copilot in your IDE for intelligent code completion
            - The generated code includes comments with the acceptance criteria
            - All files follow the project structure and conventions

            ### ‚ö†Ô∏è Important:
            This is **starter code** to help you get started quickly. You still need to:
            - Implement the actual business logic
            - Add proper error handling
            - Write tests
            - Ensure it meets all acceptance criteria

            Happy coding! üöÄ`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr_number.outputs.number }},
              body: comment
            });
